---
layout: post
title: ê³µìš© ìŠ¤í¬ë¦½íŠ¸ ì œì‘ê¸°ğŸˆ - CSV íŒŒì„œ í¸
category: devlog
tags: [unity, CoreScript, Retrospective]
image: /assets/img/blog/unity/2025/CoreBanner02.png
description: >
  Unity í”„ë¡œì íŠ¸ì˜ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œì‘í•˜ë©´ì„œ ì–´ë–»ê²Œ ë§Œë“¤ì—ˆëŠ”ì§€, ì–´ë–¤ ì ì— ì‹ ê²½ì¼ëŠ”ì§€ ì„¤ëª…í•˜ëŠ” ê¸€ì…ë‹ˆë‹¤.
comments: true
---

* this unordered seed list will be replaced by toc as unordered list
{:toc}

íŒŒì„œë¼ê³  í•˜ë©´ ì—¬ëŸ¬ê°€ì§€ê°€ ìˆëŠ”ë°... ê·¸ ì¤‘ ê°€ì¥ ë³´í¸ì ì¸ CSV íŒŒì„œë¥¼ ë§Œë“¤ì–´ë³´ë ¤ í•œë‹¤.
ë‚´ê°€ ì›í•˜ëŠ”ê±´ 'ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ìë™ ì½”ë“œ ìƒì„±ê³¼ í…Œì´ë¸” ê°„ ì°¸ì¡° í•´ê²°ì„ ì§€ì›í•˜ëŠ” ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ'.

ì¦‰, ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ê·¸ ë°ì´í„°ì˜ í˜•ì‹ì„ ì„¤ëª…í•˜ëŠ” ìŠ¤í‚¤ë§ˆê°€ ì¡´ì¬í•˜ê³ , ìŠ¤í‚¤ë§ˆë¥¼ ì½ì–´ì„œ ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ ìƒì„±í•˜ì—¬ ì°¸ì¡°ê¹Œì§€ ì½ì–´ë‚¼ ìˆ˜ ìˆëŠ” CSV íŒŒì„œë¥¼ ë§í•œë‹¤.

# ğŸ’¡ì˜ˆì‹œ
ì˜ˆë¥¼ë“¤ì–´, ê²Œì„ì— ì•„ì´í…œ ë°ì´í„°ê°€ í•„ìš”í•˜ë‹¤ê³  í•´ë³´ì. ê·¸ëŸ´ ë•Œ ì´ë ‡ê²Œ ë¨¼ì € CSVë¥¼ ë§Œë“ ë‹¤.
```
 Assets/Data/CSV/
  â”œâ”€â”€ ItemData_Schema.csv      â† ìŠ¤í‚¤ë§ˆ ì •ì˜
  â”œâ”€â”€ ItemData.csv                 â† ì‹¤ì œ ë°ì´í„°
```

ì´ ë•Œ, ì•„ì´í…œ ë°ì´í„°ì˜ ìŠ¤í‚¤ë§ˆëŠ” ì´ëŸ¬í•œ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆë‹¤.
```
ColumnName,Type,Description,Reference

ID,int,ì•„ì´í…œ ê³ ìœ  ID,
Name,string,ì•„ì´í…œ ì´ë¦„,
CategoryID,int,ì¹´í…Œê³ ë¦¬ ID,CategoryData.ID
Price,int,ê°€ê²©,
IsStackable,bool,ì¤‘ì²© ê°€ëŠ¥ ì—¬ë¶€,
MaxStack,int?,ìµœëŒ€ ì¤‘ì²© ìˆ˜
```

ì´ ìŠ¤í‚¤ë§ˆë¥¼ ë³´ê³  Unityì—ì„œ ë©”ë‰´ì˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ CodeGeneratorê°€ ë™ì‘í•œë‹¤.
ê·¸ëŸ¼ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œê°€ ìë™ìœ¼ë¡œ ìƒì„±ëœë‹¤.
```cs
  // Auto-Generated from ItemData_Schema.csv
  // ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!

  using System;
  using System.Collections.Generic;
  using UnityEngine;

  [Serializable]
  [CSVTable("ItemData")]
  public class ItemData : ICSVData
  {
      /// <summary>
      /// ì•„ì´í…œ ê³ ìœ  ID
      /// </summary>
      public int ID;

      /// <summary>
      /// ì•„ì´í…œ ì´ë¦„
      /// </summary>
      public string Name;

      /// <summary>
      /// ì¹´í…Œê³ ë¦¬ ID
      /// </summary>
      [CSVReference("CategoryData", "ID")]  // ì°¸ì¡° ì •ë³´
      public CategoryData Category;         // ì°¸ì¡° ê°ì²´ (ìë™ ìƒì„±!)

      public int CategoryID;                // ID í•„ë“œ (ì›ë³¸)

      /// <summary>
      /// ê°€ê²©
      /// </summary>
      public int Price;

      /// <summary>
      /// ì¤‘ì²© ê°€ëŠ¥ ì—¬ë¶€
      /// </summary>
      public bool IsStackable;

      /// <summary>
      /// ìµœëŒ€ ì¤‘ì²© ìˆ˜
      /// </summary>
      public int? MaxStack;                 // â† Nullable íƒ€ì…!
  }
```

ì´í›„ ìë™ìœ¼ë¡œ csvëŠ” ë‹¤ìŒì˜ ê³¼ì •ì„ ê±°ì¹œë‹¤
- ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬
-  Addressablesì— ë“±ë¡
ì´ë¥¼ ëŸ°íƒ€ì„ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•œë‹¤
```cs
List<ItemData> allItems = CSVManager.Instance.GetTable<ItemData>();
```


ë‹¤ìŒìœ¼ë¡œëŠ” êµ¬í˜„ì€ ì–´ë–»ê²Œ í–ˆëŠ”ì§€ ìƒì„¸í•˜ê²Œ ì„¤ëª…í•´ ë³´ê² ë‹¤. 
# ğŸ“Š í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
  ICSVData (ì¸í„°í˜ì´ìŠ¤)
      â†‘ implements
  ItemData, CategoryData, ... (ìƒì„±ëœ í´ë˜ìŠ¤ë“¤)
      â†“ uses
  CSVManager (ì‹±ê¸€í†¤)
      â”œâ”€> CSVSchemaParser
      â”œâ”€> CSVParser
      â”‚      â””â”€> CSVComplexTypeParser
      â”œâ”€> CSVCircularReferenceChecker
      â””â”€> CSVReferenceResolver

  CSVCodeGenerator (ì—ë””í„° ì „ìš©)
      â”œâ”€> CSVSchema / CSVSchemaColumn
      â””â”€> Addressables ì„¤ì •
```

ë³µì¡í•´ ë³´ì´ì§€ë§Œ í•˜ë‚˜ì”© ëœ¯ì–´ë³´ë©´ ì´í•´ê°€ ê°ˆ ê²ƒì´ë‹¤.

---

# ğŸ“ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
## í•µì‹¬ ì»´í¬ë„ŒíŠ¸
###### CSVManager (ì‹±ê¸€í†¤ ë§¤ë‹ˆì €)
  - ì—­í• : ì „ì²´ CSV ë°ì´í„°ì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬
  - ì£¼ìš” ê¸°ëŠ¥:
    - ëª¨ë“  CSV í…Œì´ë¸”ì˜ ë¡œë”© ë° ì´ˆê¸°í™”
    - í…Œì´ë¸” ê°„ ì°¸ì¡° ìë™ í•´ê²°
    - ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬
    - ë¡œë“œëœ ë°ì´í„°ì— ëŒ€í•œ ì ‘ê·¼ ì¸í„°í˜ì´ìŠ¤ ì œê³µ
- Initialize() í”„ë¡œì„¸ìŠ¤:
  1. Assemblyì—ì„œ ICSVData êµ¬í˜„ íƒ€ì… ê²€ìƒ‰
  2. ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë¡œë“œ (_Schema.csv)
  3. ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬
  4. ëª¨ë“  ë°ì´í„° ë¡œë“œ (Addressables)
  5. ì°¸ì¡° í•´ê²° (ID â†’ ê°ì²´ ì—°ê²°)

###### CSVParser (íŒŒì‹± ì—”ì§„)
  - ì—­í• : CSV íŒŒì¼ì„ C# ê°ì²´ë¡œ ë³€í™˜
  - ì£¼ìš” ê¸°ëŠ¥:
    - Addressables ê¸°ë°˜ ë¹„ë™ê¸° ë¡œë”©
    - ë¦¬í”Œë ‰ì…˜ ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
    - ë‹¤ì–‘í•œ íƒ€ì… ì§€ì› (ê¸°ë³¸ íƒ€ì…, Nullable, ë³µí•© íƒ€ì…)
    - CSV Injection ë°©ì–´
    - ë‘ ê°€ì§€ íŒŒì‹± ëª¨ë“œ ì§€ì›
		- Lenient ëª¨ë“œ: ë³€í™˜ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
		- Strict ëª¨ë“œ: ë³€í™˜ ì‹¤íŒ¨ ì‹œ í–‰ ì „ì²´ ìŠ¤í‚µ
 
###### CSVCodeGenerator (ì—ë””í„° ì „ìš©)
  - ì—­í• : ìŠ¤í‚¤ë§ˆ íŒŒì¼ë¡œë¶€í„° C# í´ë˜ìŠ¤ ìë™ ìƒì„±
  - ì£¼ìš” ê¸°ëŠ¥:
    - Dirty Check (ë³€ê²½ëœ ìŠ¤í‚¤ë§ˆë§Œ ì¬ìƒì„±)
    - Addressables ìë™ ë“±ë¡
    - ê³ ì•„ íŒŒì¼ ê²€ì‚¬ ë° ì‚­ì œ
    - ì°¸ì¡° í•„ë“œ ìë™ ìƒì„±
  ItemData_Schema.csv
      â†“ (Generate)
  ItemData.cs (ICSVData êµ¬í˜„)
      â†“ (Auto Register)
  Addressables "CSV Data" Group

  ---
## ì°¸ì¡° ì‹œìŠ¤í…œ
###### CSVReferenceResolver
  - ì—­í• : í…Œì´ë¸” ê°„ ì°¸ì¡°ë¥¼ IDë¡œë¶€í„° ì‹¤ì œ ê°ì²´ë¡œ ì—°ê²°
  - ë™ì‘ ë°©ì‹: ìŠ¤í‚¤ë§ˆë¥¼ ë³´ê³  â†’ ì½”ë“œë¥¼ ìƒì„±í•˜ê³  â†’ ëŸ°íƒ€ì„ì— ìë™ ì—°ê²°í•©ë‹ˆë‹¤.

###### CSVCircularReferenceChecker
  - ì—­í• : í…Œì´ë¸” ê°„ ìˆœí™˜ ì°¸ì¡° íƒì§€
  - ì•Œê³ ë¦¬ì¦˜: DFS (Depth-First Search)
  - ë™ì‘ ì‹œì : Initialize() ì´ˆê¸°í™” ë‹¨ê³„
  - ìˆœí™˜ ì°¸ì¡° ì˜ˆì‹œ (ì—ëŸ¬): A â†’ B â†’ C â†’ A

  ---
## íƒ€ì… ì‹œìŠ¤í…œ

###### CSVComplexTypeParser
  - ì—­í• : ë³µí•© íƒ€ì…(ë°°ì—´, ë¦¬ìŠ¤íŠ¸, ë”•ì…”ë„ˆë¦¬, ì»¤ìŠ¤í…€ í´ë˜ìŠ¤) íŒŒì‹±
  - ì§€ì› íƒ€ì…:
    - ì»¤ìŠ¤í…€ íƒ€ì…: JSON í˜•ì‹ â†’ "{\"x\":10,\"y\":20}"
    - ë°°ì—´: "1;2;3"
    - ë”•ì…”ë„ˆë¦¬: "hp:100;mp:50"
    - ë¦¬ìŠ¤íŠ¸: "1;2;3"

###### CSVSchema / CSVSchemaColumn
  - ì—­í• : ìŠ¤í‚¤ë§ˆ ì •ë³´ ëª¨ë¸ë§
  - êµ¬ì¡°:
	  - ColumnName: "CategoryID"
	  - Type: "int"
	  - Description: "ì¹´í…Œê³ ë¦¬ ID"
	  - Reference: "CategoryData.ID"  // ì„ íƒì 

  ---
## ì†ì„± ì‹œìŠ¤í…œ

###### CSVTableAttribute
\[CSVTable("ItemData")]  // í…Œì´ë¸”ëª… ì§€ì •
public class ItemData : ICSVData { }
CSVReferenceAttribute

\[CSVReference("CategoryData", "ID")]  // ì°¸ì¡° ì •ë³´
public CategoryData Category;

###### ICSVData (ì¸í„°í˜ì´ìŠ¤)
  - ëª¨ë“  CSV ë°ì´í„° í´ë˜ìŠ¤ê°€ êµ¬í˜„í•˜ëŠ” ë§ˆì»¤ ì¸í„°í˜ì´ìŠ¤
  - CSVManagerê°€ Assemblyì—ì„œ íƒ€ì…ì„ ì°¾ì„ ë•Œ ì‚¬ìš©

  ---
# ğŸ”„ ë°ì´í„° íë¦„

###### ê°œë°œ ë‹¨ê³„ (ì—ë””í„°)
  1. ItemData_Schema.csv ì‘ì„±
  2. ItemData.csv ì‘ì„±
  3. Unityì—ì„œ Tools > CSV > Generate Scripts ì‹¤í–‰
     â†“
  4. \[CSVCircularReferenceChecker] ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬
  5. ItemData.cs ìë™ ìƒì„± ë° Addressablesì— ìë™ ë“±ë¡

###### ëŸ°íƒ€ì„ ë‹¨ê³„
  5. \[ê²Œì„ ì‹œì‘] CSVManager.Initialize() í˜¸ì¶œ
     â†“
  6. \[CSVManager] ICSVData íƒ€ì… ê²€ìƒ‰
  7. \[CSVSchemaParser] ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë¡œë“œ
  8. \[CSVParser] Addressablesë¡œ CSV íŒŒì¼ ë¹„ë™ê¸° ë¡œë“œ
  9. \[CSVParser] ë¦¬í”Œë ‰ì…˜ìœ¼ë¡œ ê°ì²´ ìƒì„± ë° ê°’ í• ë‹¹
  10. \[CSVReferenceResolver] í…Œì´ë¸” ê°„ ì°¸ì¡° í•´ê²°
     â†“
  11. \[ì™„ë£Œ] CSVManager.GetTable<>() ì‚¬ìš© ê°€ëŠ¥

  ---
# ğŸ¯ ì‹ ê²½ ì“´ ë¶€ë¶„

###### ë¦¬í”Œë ‰ì…˜ ìºì‹±
- ë”± í•œ ë²ˆ GetField()ë¥¼ í˜¸ì¶œí•˜ê³ , ColumnMapperë¥¼ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë¦¬í”Œë ‰ì…˜ ê²°ê³¼ë¥¼ ì¬ì‚¬ìš© í•¨
```cs
private class ColumnMapper
  {
      public string HeaderName;        // CSV í—¤ë”ëª… (ì˜ˆ: "Name")
      public FieldInfo Field;          // ë¦¬í”Œë ‰ì…˜ ê²°ê³¼ ìºì‹œ
      public PropertyInfo Property;    // í”„ë¡œí¼í‹° ìºì‹œ
      public Type TargetType;          // íƒ€ì… ì •ë³´ ìºì‹œ
      public bool IsNullable;          // Nullable ì—¬ë¶€ ìºì‹œ
      public Type UnderlyingType;      // ê¸°ë³¸ íƒ€ì… ìºì‹œ
  }
```

###### List ìƒì„± ì‹œ ìµœì í™”
- ìƒì„± ì‹œ ì˜ˆìƒ í¬ê¸°ë¥¼ ì§€ì •í•˜ì—¬ Capacityë¥¼ ìµœì í™”
```cs
 int estimatedRows = lines.Length - 1;  // ì •í™•í•œ í–‰ ìˆ˜ ê³„ì‚°
 List<T> result = new List<T>(estimatedRows);  // ì´ˆê¸° ìš©ëŸ‰ ì„¤ì •
```
###### Dirty Check ì‚¬ìš©
- ë³€ê²½ë˜ì§€ ì•Šì€ ìŠ¤í‚¤ë§ˆëŠ” ì†ì•„ë‚´ê³  ë³€ê²½ëœ ìŠ¤í‚¤ë§ˆë§Œ ì¬ìƒì„±
- ë³„ë„ë¡œ, ì‚­ì œëœ CSVì— ëŒ€ì‘í•˜ëŠ” .cs íŒŒì¼ë„ ìë™ ê²€ì‚¬í•˜ì—¬ ì‚­ì œí•˜ê² ëƒëŠ” ì•Œë¦¼ ë„ì›€
```cs
private static bool IsDirty(string schemaPath, string csFilePath)
  {
      // 1. C# íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ ìƒì„± í•„ìš”
      if (!File.Exists(csFilePath))
          return true;

      // 2. íŒŒì¼ì˜ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
      System.DateTime schemaTime = File.GetLastWriteTime(schemaPath);
      System.DateTime csTime = File.GetLastWriteTime(csFilePath);

      // 3. ìŠ¤í‚¤ë§ˆê°€ ë” ìµœì‹ ì´ë©´ ì¬ìƒì„± í•„ìš”
      return schemaTime > csTime;
  }
```

###### ìˆœí™˜ ì°¸ì¡° ê²€ì‚¬
- ì‹œíŠ¸ê°€ ë‹¤ë¥¸ ì‹œíŠ¸ë¥¼ ì°¸ì¡°í•  ë•Œ ìˆœí™˜ì°¸ì¡°í•˜ì§€ ëª»í•˜ë„ë¡ ê²½ê³ ë¥¼ ë„ì›Œì¤Œ
- DFSë¡œ ìˆœí™˜ ì°¸ì¡° ê²€ê°€
```cs
 public static bool HasCircularReference(graph, out List<string> cycle)
  {
      var visited = new HashSet<string>();        // ë°©ë¬¸í•œ ë…¸ë“œ
      var recursionStack = new HashSet<string>(); // í˜„ì¬ ê²½ë¡œìƒì˜ ë…¸ë“œ
      var path = new List<string>();              // í˜„ì¬ ê²½ë¡œ

      // ëª¨ë“  ë…¸ë“œì—ì„œ DFS ì‹œì‘
      foreach (var node in graph.Keys)
      {
          if (!visited.Contains(node))
          {
              if (DFS(node, graph, visited, recursionStack, path, out cycle))
              {
                  return true;  // ìˆœí™˜ ë°œê²¬!
              }
          }
      }

      cycle = null;
      return false;  // ìˆœí™˜ ì—†ìŒ
  }
```

---
# ê²°ë¡ 
ì‹ ê²½ì¨ì„œ ë§Œë“¤ì–´ë´¤ëŠ”ë° ì˜ êµ´ëŸ¬ê°ˆì§€ ì˜ë¬¸ì´ë‹¤. í•˜ë©´ì„œ ë” ê°œì„ í•´ë‚˜ê°€ì§€ ì•Šì„ê¹Œ ì‹¶ë‹¤.
