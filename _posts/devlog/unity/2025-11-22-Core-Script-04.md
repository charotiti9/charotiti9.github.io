---
layout: post
title: ê³µìš© ìŠ¤í¬ë¦½íŠ¸ ì œì‘ê¸°ğŸˆ - StateMachine í¸
category: devlog
tags: [unity, CoreScript, Retrospective]
image: /assets/img/blog/unity/2025/CoreBanner04.png
description: >
  Unity í”„ë¡œì íŠ¸ì˜ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œì‘í•˜ë©´ì„œ ì–´ë–»ê²Œ ë§Œë“¤ì—ˆëŠ”ì§€, ì–´ë–¤ ì ì— ì‹ ê²½ì¼ëŠ”ì§€ ì„¤ëª…í•˜ëŠ” ê¸€ì…ë‹ˆë‹¤.
comments: true
---

* this unordered seed list will be replaced by toc as unordered list
{:toc}

ì›ë˜ ê·¸ëƒ¥ ê°„ë‹¨í•œ Enum-Stateë¬¸ì˜ StateMachineì„ ë²„ë¦‡ì²˜ëŸ¼ ì‚¬ìš©í•˜ë‹¤ê°€, ì´ì œëŠ” Genericí•œ ìƒíƒœë¨¸ì‹ ì„ ë§Œë“¤ì–´ì•¼ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´ì„œ ì‘ì„±í•´ë³¸ë‹¤.
ì´ì „ì— ë§Œë“¤ì—ˆë˜ GameFlowManagerë¥¼ í™œìš©í•˜ëŠ” ë©´ì´ ìˆìœ¼ë‹ˆ ì´ì „ í¸ì„ ì½ê³ ì˜¤ë©´ ì¢‹ë‹¤.

# ğŸ’¡ì˜ˆì‹œ

ê°„ë‹¨í•˜ê²Œ ë¨¼ì € ì‚¬ìš© ì˜ˆì‹œë¶€í„° ì†Œê°œí•´ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

ë¨¼ì € ì»¨í…ìŠ¤íŠ¸ë¥¼ ì •ì˜í•œë‹¤. ì»¨í…ìŠ¤íŠ¸ ì•ˆì—ëŠ” ìƒíƒœê°€ ì‚¬ìš©í•  ë°ì´í„°ë¥¼ ë‹´ëŠ”ë‹¤.
```cs
public class ExampleContext
{
    public int Value { get; set; }
}
```

StateëŠ” ì´ë ‡ê²Œ ë§Œë“ ë‹¤.
```cs
public class State : IState<ExampleContext>
{
    public void Enter(ExampleContext context)
    {
        Debug.Log("State ì§„ì…");
        context.Value = 2;
    }

    public void Update(ExampleContext context, float deltaTime)
    {
        // ì—…ë°ì´íŠ¸ ë¡œì§
    }

    public void Exit(ExampleContext context)
    {
        Debug.Log("State ì¢…ë£Œ");
    }
}
```

StateMachineì€ ì´ë ‡ê²Œ ì‚¬ìš©í•œë‹¤.
```cs
public class StateMachineExample : MonoBehaviour
{
    private StateMachine<ExampleContext> stateMachine;

    private void Awake()
    {
        var context = new ExampleContext { Value = 0 };
        stateMachine = new StateMachine<ExampleContext>(context);
        stateMachine.ChangeState(new State());
    }

    private void OnDestroy()
    {
        stateMachine?.Dispose();
    }
}
```

# ğŸ“Š í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
IUpdatable (GameFlowManagerì™€ í†µí•©)
    â†‘
    â”‚ implements
    â”‚
StateMachine<TContext>
    â”‚
    â”œâ”€ TContext (ì°¸ì¡°)
    â”‚   â””â”€ ìƒíƒœê°€ ì¡°ì‘í•  ë°ì´í„°
    â”‚
    â”œâ”€ IState<TContext> currentState
    â”œâ”€ IState<TContext> previousState
    â”‚
    â”œâ”€ StateTransitionValidator (ë¸ë¦¬ê²Œì´íŠ¸)
    â””â”€ OnStateChanged (ì´ë²¤íŠ¸)

IState<TContext>
    â†‘
    â”‚ implements
    â”‚
    â”œâ”€ IdleState
    â”œâ”€ WalkState
    â”œâ”€ AttackState
    â””â”€ ...
```

# ğŸ“ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## í•µì‹¬ ì»´í¬ë„ŒíŠ¸

###### IState ì¸í„°í˜ì´ìŠ¤
Generic ìƒíƒœ ì¸í„°í˜ì´ìŠ¤ë¡œ, ëª¨ë“  ìƒíƒœê°€ êµ¬í˜„í•´ì•¼ í•˜ëŠ” ìƒëª…ì£¼ê¸° ë©”ì„œë“œë¥¼ ì •ì˜í•œë‹¤.
```cs
public interface IState<TContext> where TContext : class
{
    void Enter(TContext context);   // ìƒíƒœ ì§„ì… ì‹œ
    void Update(TContext context, float deltaTime);  // ë§¤ í”„ë ˆì„
    void Exit(TContext context);    // ìƒíƒœ ì¢…ë£Œ ì‹œ
}
```

###### StateMachine í´ë˜ìŠ¤
ìƒíƒœ ë¨¸ì‹ ì˜ í•µì‹¬ ë¡œì§ì„ ë‹´ë‹¹í•˜ë©°, IUpdatableì„ êµ¬í˜„í•˜ì—¬ GameFlowManagerì™€ ìë™ í†µí•©ëœë‹¤.
- Context ê´€ë¦¬: ìƒíƒœê°€ ì¡°ì‘í•  ë°ì´í„° ê°ì²´ ë³´ê´€
- ìƒíƒœ ì „í™˜: ChangeState(), RevertToPreviousState()
- ìƒíƒœ ê²€ì¦: StateTransitionValidator ë¸ë¦¬ê²Œì´íŠ¸ë¡œ ì˜ëª»ëœ ì „í™˜ ë°©ì§€
- ì´ë²¤íŠ¸: OnStateChangedë¡œ ìƒíƒœ ë³€í™” ì¶”ì 
- ìƒëª…ì£¼ê¸°: GameFlowManager ìë™ ë“±ë¡/í•´ì œ

###### Context íŒ¨í„´
ìƒíƒœê°€ ì¡°ì‘í•  ë°ì´í„°ë¥¼ Context ê°ì²´ë¡œ ë¶„ë¦¬í•œë‹¤.
- ìƒíƒœëŠ” Contextë§Œ ì•Œë©´ ë˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ëª°ë¼ë„ ë¨
- ìƒíƒœë§ˆë‹¤ í•„ìš”í•œ ë°ì´í„°ë¥¼ Contextë¡œ ì „ë‹¬
- class íƒ€ì…ë§Œ ì‚¬ìš© ê°€ëŠ¥ (`where TContext : class` ì œì•½)

# ğŸ”„ ë°ì´í„° íë¦„

- StateMachine ìƒì„± ì‹œ Context ì „ë‹¬
- ìƒì„±ìì—ì„œ GameFlowManagerì— ìë™ ë“±ë¡
- ChangeState() í˜¸ì¶œ â†’ ìƒíƒœ ì „í™˜
  - TransitionValidator ê²€ì¦ (ìˆìœ¼ë©´)
  - currentState.Exit()
  - previousState ì €ì¥
  - currentState êµì²´
  - newState.Enter()
  - OnStateChanged ì´ë²¤íŠ¸ ë°œìƒ
- GameFlowManagerê°€ ë§¤ í”„ë ˆì„ OnUpdate() í˜¸ì¶œ
  - currentState.Update(context, deltaTime) ì‹¤í–‰
- Dispose() í˜¸ì¶œ â†’ GameFlowManagerì—ì„œ í•´ì œ
- ì†Œë©¸

# ğŸ¯ ì‹ ê²½ ì“´ ë¶€ë¶„

###### GameFlowManager ìë™ í†µí•©
StateMachineì€ IUpdatableì„ êµ¬í˜„í•˜ì—¬ GameFlowManagerì— ìë™ìœ¼ë¡œ ë“±ë¡ëœë‹¤.
ë”°ë¼ì„œ MonoBehaviourì˜ Update()ì—ì„œ ì§ì ‘ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ë‹¤.
```cs
public StateMachine(TContext context)
{
    this.context = context;
    // ìƒì„±ê³¼ ë™ì‹œì— ìë™ ë“±ë¡!
    GameFlowManager.Instance.RegisterUpdatable(this);
}
```

###### ìƒíƒœ ì „í™˜ ê²€ì¦ ì‹œìŠ¤í…œ
TransitionValidatorë¥¼ í†µí•´ ì˜ëª»ëœ ìƒíƒœ ì „í™˜ì„ ë°©ì§€í•œë‹¤.
```cs
stateMachine.TransitionValidator = (from, to) =>
{
    // ì²´ë ¥ì´ 0 ì´í•˜ë©´ ì£½ìŒ ìƒíƒœë¡œë§Œ ì „í™˜ ê°€ëŠ¥
    if (context.Health <= 0 && !(to is DeadState))
    {
        Debug.LogWarning("ì²´ë ¥ì´ 0ì…ë‹ˆë‹¤. ì£½ìŒ ìƒíƒœë¡œë§Œ ì „í™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return false;
    }
    return true;
};
```

###### ì´ì „ ìƒíƒœ ì¶”ì 
previousStateë¥¼ ì €ì¥í•˜ì—¬ RevertToPreviousState()ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆë‹¤.
```cs
// í”¼ê²© í›„ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
public class HitState : IState<PlayerContext>
{
    public void Update(PlayerContext context, float deltaTime)
    {
        if (IsHitAnimationFinished())
        {
            stateMachine.RevertToPreviousState();  // ì´ì „ ìƒíƒœë¡œ!
        }
    }
}
```

###### ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
Dispose íŒ¨í„´ì„ êµ¬í˜„í•˜ì—¬ ëª…í™•í•œ ë¦¬ì†ŒìŠ¤ í•´ì œë¥¼ ë³´ì¥í•œë‹¤.
Dispose()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ ì†Œë©¸ìì—ì„œ ê²½ê³  ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•œë‹¤.
```cs
~StateMachine()
{
    if (!isDisposed)
    {
        Debug.LogWarning($"[ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê²½ê³ ] StateMachine<{typeof(TContext).Name}>ì´(ê°€) Dispose()ë˜ì§€ ì•Šê³  ì†Œë©¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
}
```

# ê²°ë¡ 
Switch-Caseë¡œ ë„ë°°ëœ ìƒíƒœë¨¸ì‹ ì€ ì´ì œ ì•ˆë…•.
