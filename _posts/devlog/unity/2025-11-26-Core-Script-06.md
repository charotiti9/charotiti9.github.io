---
layout: post
title: ê³µìš© ìŠ¤í¬ë¦½íŠ¸ ì œì‘ê¸°ğŸˆ - Object Pool í¸
category: devlog
tags: [unity, CoreScript, Retrospective]
image: /assets/img/blog/unity/2025/CoreBanner06.png
description: >
  Unity í”„ë¡œì íŠ¸ì˜ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œì‘í•˜ë©´ì„œ ì–´ë–»ê²Œ ë§Œë“¤ì—ˆëŠ”ì§€, ì–´ë–¤ ì ì— ì‹ ê²½ì¼ëŠ”ì§€ ì„¤ëª…í•˜ëŠ” ê¸€ì…ë‹ˆë‹¤.
comments: true
---

* this unordered seed list will be replaced by toc as unordered list
{:toc}

ê²Œì„ì„ ë§Œë“¤ë‹¤ë³´ë©´ ë°˜ë³µì ìœ¼ë¡œ ìƒì„±/íŒŒê´´ë˜ëŠ” ì˜¤ë¸Œì íŠ¸ë“¤ì´ ë§ë‹¤. ì´ì•Œ, ì´í™íŠ¸, ì  ìºë¦­í„° ë“±ë“±. ì´ëŸ° ê²ƒë“¤ì„ ë§¤ë²ˆ Instantiate/Destroy í•˜ë©´ GCê°€ ë¯¸ì³ ë‚ ë›´ë‹¤. ê·¸ë˜ì„œ ë²”ìš©ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì˜¤ë¸Œì íŠ¸ í’€ë§ ì‹œìŠ¤í…œì„ ë§Œë“¤ê¸°ë¡œ í–ˆë‹¤.

ë‚´ê°€ ì›í•˜ëŠ”ê±´ Attributeë§Œ ë‹¬ì•„ì£¼ë©´ PoolManagerê°€ ì•Œì•„ì„œ í’€ë§ì„ ê´€ë¦¬í•˜ê³ , Addressableë¡œ ë¹„ë™ê¸° ë¡œë”©ê¹Œì§€ ì§€ì›í•˜ëŠ” ì‹œìŠ¤í…œì´ì—ˆë‹¤.
# ğŸ’¡ì˜ˆì‹œ
ì˜ˆë¥¼ë“¤ì–´, ê²Œì„ì— ì´ì•Œ í”„ë¦¬íŒ¹ì´ í•„ìš”í•˜ë‹¤ê³  í•´ë³´ì. ê·¸ëŸ´ ë•Œ ì´ë ‡ê²Œ ë¨¼ì € Component í´ë˜ìŠ¤ë¥¼ ë§Œë“ ë‹¤.
```cs
[PoolAddress("Prefabs/Bullet")]  // Addressable ì£¼ì†Œë§Œ ì§€ì •
public class Bullet : MonoBehaviour, IPoolable
{
    public void OnGetFromPool()
    {
        // í’€ì—ì„œ êº¼ë‚¼ ë•Œ ì´ˆê¸°í™”
        gameObject.SetActive(true);
    }

    public void OnReturnToPool()
    {
        // í’€ë¡œ ë°˜í™˜í•  ë•Œ ì •ë¦¬
        gameObject.SetActive(false);
    }
}
```

ì´í›„ ì‚¬ìš©í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê°„ë‹¨í•˜ê²Œ ì‚¬ìš©í•œë‹¤.
```cs
// í’€ì—ì„œ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë¡œë“œ)
Bullet bullet = await PoolManager.GetFromPool<Bullet>(ct);

// ì‚¬ìš©...

// í’€ë¡œ ë°˜í™˜
PoolManager.ReturnToPool(bullet);
```

í•„ìš”í•˜ë‹¤ë©´ í”„ë¦¬ë¡œë“œë„ ê°€ëŠ¥í•˜ë‹¤.
```cs
// ê²Œì„ ì‹œì‘ ì‹œ 10ê°œ ë¯¸ë¦¬ ìƒì„±
await PoolManager.PreloadPool<Bullet>(10, ct);
```

ë‹¤ìŒìœ¼ë¡œëŠ” êµ¬í˜„ì€ ì–´ë–»ê²Œ í–ˆëŠ”ì§€ ìƒì„¸í•˜ê²Œ ì„¤ëª…í•´ ë³´ê² ë‹¤.

# ğŸ“Š í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
IPoolable (ì¸í„°í˜ì´ìŠ¤)
    â†‘ implements
Bullet, Enemy, Effect, ... (ì‚¬ìš©ì ì •ì˜ í´ë˜ìŠ¤ë“¤)
    â†“ uses
PoolManager (ì •ì  í´ë˜ìŠ¤)
    â”œâ”€ ObjectPool<T>
    â”‚      â”œâ”€ PoolStorage<T> (ì €ì¥ì†Œ)
    â”‚      â”œâ”€ InstanceLifecycle<T> (ìƒëª…ì£¼ê¸°)
    â”‚      â”œâ”€ InstanceTracker<T> (ì¶”ì )
    â”‚      â””â”€ ReferenceCounter (ì°¸ì¡° ì¹´ìš´íŒ…)
    â””â”€ AttributeCache<T> (Attribute ìºì‹±)

ObjectPoolBase (ì¶”ìƒ í´ë˜ìŠ¤)
    â†‘ extends
ObjectPool<T>
```

---

# ğŸ“ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
## í•µì‹¬ ì»´í¬ë„ŒíŠ¸
###### PoolManager
- ì—­í• : ì „ì²´ í’€ë§ ì‹œìŠ¤í…œì˜ ì§„ì…ì 
- ì£¼ìš” ê¸°ëŠ¥:
  - Attribute ê¸°ë°˜ ìë™ í’€ ìƒì„±
  - íƒ€ì…ë³„ ObjectPool ìºì‹± ë° ê´€ë¦¬
  - Parent Transform ìë™ ìƒì„± ë° ìºì‹±
  - ì”¬ ì „í™˜ ì‹œ ìë™ ì •ë¦¬
- í•µì‹¬ API:
  - GetFromPool: í’€ì—ì„œ ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
  - ReturnToPool: í’€ë¡œ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜
  - PreloadPool: ë¯¸ë¦¬ ë¡œë“œ
  - ClearAllPools: ëª¨ë“  í’€ ë¹„ìš°ê¸°

###### ObjectPool
- ì—­í• : Component íƒ€ì…ë³„ ì‹¤ì œ í’€ë§ ë¡œì§ êµ¬í˜„
- ì£¼ìš” ê¸°ëŠ¥:
  - Addressable/Resources ë¹„ë™ê¸° ë¡œë”©
  - ì¸ìŠ¤í„´ìŠ¤ ìƒëª…ì£¼ê¸° ê´€ë¦¬
  - ì°¸ì¡° ì¹´ìš´íŒ… ë° ë©”ëª¨ë¦¬ ì•ˆì „ì„±
  - í’€ í¬ê¸° ì œí•œ ë° ìë™ ì •ë¦¬
- ìƒì„± ë°©ì‹:
  - CreateForAddressable
  - CreateForResources
  - CreateCustom

###### PoolStorage
- ì—­í• : í’€ ë‚´ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ ë° ê´€ë¦¬
- ì£¼ìš” ê¸°ëŠ¥:
  - íƒ€ì…ë³„ Queue ê´€ë¦¬ (Dictionary<Type, Queue>)
  - í’€ í¬ê¸° ì œí•œ (íƒ€ì…ë³„ ì„¤ì • ê°€ëŠ¥)
  - FIFO ë°©ì‹ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬
  - ë¹ ë¥¸ TryTake/Store ì—°ì‚°


---
## Attribute ì‹œìŠ¤í…œ

###### PoolAddressAttribute
```cs
[PoolAddress("Prefabs/Bullet")]  // Pool Container ì‚¬ìš©
public class Bullet : MonoBehaviour { }

[PoolAddress("Prefabs/Enemy", "EnemyContainer")]  // ì‚¬ìš©ì ì§€ì • ë¶€ëª¨
public class Enemy : MonoBehaviour { }

[PoolAddress("Prefabs/UI", dontDestroyOnLoad: true)]  // ì”¬ ì „í™˜ì—ë„ ìœ ì§€
public class UIPanel : MonoBehaviour { }
```

- Address: Addressable ì£¼ì†Œ ë˜ëŠ” Resources ê²½ë¡œ
- ParentName: ë¶€ëª¨ GameObject ì´ë¦„ (ì„ íƒì )
- UsePoolContainer: Pool Container ì‚¬ìš© ì—¬ë¶€
- DontDestroyOnLoad: ì”¬ ì „í™˜ ì‹œ ìœ ì§€ ì—¬ë¶€

###### AttributeCache (ì •ì  ìºì‹±)
- PoolManager ë‚´ë¶€ í´ë˜ìŠ¤
- íƒ€ì…ë³„ Attribute ì •ë³´ë¥¼ ì •ì  ìƒì„±ìì—ì„œ í•œ ë²ˆë§Œ ì¶”ì¶œ
- ë¦¬í”Œë ‰ì…˜ ì˜¤ë²„í—¤ë“œ ì œê±° (ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰)

###### IPoolable (ì¸í„°í˜ì´ìŠ¤)
- ëª¨ë“  í’€ë§ ê°€ëŠ¥í•œ ê°ì²´ê°€ êµ¬í˜„í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
- OnGetFromPool(): í’€ì—ì„œ êº¼ë‚¼ ë•Œ í˜¸ì¶œ
- OnReturnToPool(): í’€ë¡œ ë°˜í™˜í•  ë•Œ í˜¸ì¶œ

---
## ì°¸ì¡° ê´€ë¦¬ ì‹œìŠ¤í…œ

###### ReferenceCounter
- ì—­í• : í”„ë¦¬íŒ¹ë³„ ì¸ìŠ¤í„´ìŠ¤ ê°œìˆ˜ ì¶”ì 
- ë™ì‘ ë°©ì‹:
  1. í”„ë¦¬íŒ¹ ìµœì´ˆ ë¡œë“œ ì‹œ ì°¸ì¡° ì¹´ìš´íŠ¸ 1ë¡œ ì‹œì‘
  2. ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ë§ˆë‹¤ Increase()
  3. ì¸ìŠ¤í„´ìŠ¤ íŒŒê´´ë§ˆë‹¤ Decrease()
  4. ì°¸ì¡° ì¹´ìš´íŠ¸ê°€ 0ì´ ë˜ë©´ ìë™ìœ¼ë¡œ í”„ë¦¬íŒ¹ í•´ì œ
- ë©”ëª¨ë¦¬ ì•ˆì „ì„± ë³´ì¥

###### InstanceTracker
- ì—­í• : í™œì„± ì¸ìŠ¤í„´ìŠ¤ì˜ ë©”íƒ€ë°ì´í„° ì¶”ì 
- ì¶”ì  ì •ë³´:
  - Address: ì›ë³¸ ë¦¬ì†ŒìŠ¤ ì£¼ì†Œ
  - Type: Component íƒ€ì…
  - TargetParent: ì›ë˜ ë¶€ëª¨ Transform
- ìš©ë„: Return ì‹œ ì˜¬ë°”ë¥¸ ì •ë¦¬ ìˆ˜í–‰

###### InstanceLifecycle
- ì—­í• : ì¸ìŠ¤í„´ìŠ¤ ìƒì„±/í™œì„±í™”/ë¹„í™œì„±í™”/íŒŒê´´ ê´€ë¦¬
- ì£¼ìš” ë©”ì„œë“œ:
  - Create: GameObject.Instantiate + Component ì¶”ì¶œ
  - Activate: SetActive(true) + Parent ì„¤ì •
  - Deactivate: SetActive(false) + Parent ë³µì›
  - Destroy: IPoolable.OnReturnToPool + GameObject.Destroy

---
# ğŸ”„ ë°ì´í„° íë¦„

###### ìµœì´ˆ ì‚¬ìš© (í’€ ìƒì„±)
1. PoolManager.GetFromPool() í˜¸ì¶œ
   â†“
2. \[AttributeCache] Attribute ì¶”ì¶œ
3. \[PoolManager] ObjectPool ìƒì„± ë° ìºì‹±
4. \[ObjectPool] ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ë¡œë“œ
   â†“
5. \[AddressableLoader] í”„ë¦¬íŒ¹ ë¹„ë™ê¸° ë¡œë“œ
6. \[InstanceLifecycle] GameObject.Instantiate
7. \[InstanceTracker] ë©”íƒ€ë°ì´í„° ì¶”ì  ì‹œì‘
8. \[ReferenceCounter] ì°¸ì¡° ì¹´ìš´íŠ¸ ì¦ê°€
   â†“
9. \[ì™„ë£Œ] Bullet ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜

###### ì¬ì‚¬ìš© (í’€ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
10. PoolManager.GetFromPool() í˜¸ì¶œ
    â†“
11. \[PoolStorage] TryTake() â†’ í’€ì— ìˆìŒ!
12. \[InstanceLifecycle] Activate(SetActive(true))
13. \[IPoolable] OnGetFromPool() í˜¸ì¶œ
    â†“
14. \[ì™„ë£Œ] ì¬ì‚¬ìš©ëœ Bullet ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜

###### ë°˜í™˜ (í’€ë¡œ ë˜ëŒë¦¬ê¸°)
15. PoolManager.ReturnToPool(bullet) í˜¸ì¶œ
    â†“
16. \[InstanceTracker] ë©”íƒ€ë°ì´í„° ì¡°íšŒ (Address, Type, Parent)
17. \[PoolStorage] í’€ í¬ê¸° í™•ì¸
    â†“
18. **í’€ì— ê³µê°„ ìˆìŒ**
    - \[IPoolable] OnReturnToPool() í˜¸ì¶œ
    - \[InstanceLifecycle] Deactivate(SetActive(false))
    - \[PoolStorage] Queueì— ì €ì¥
    â†“
19. **í’€ í¬ê¸° ì´ˆê³¼**
    - \[InstanceTracker] Untrack()
    - \[InstanceLifecycle] Destroy()
    - \[ReferenceCounter] Decrease() â†’ 0ì´ë©´ í”„ë¦¬íŒ¹ í•´ì œ

---
# ğŸ¯ ì‹ ê²½ ì“´ ë¶€ë¶„

###### Parent Transform ìºì‹±
- ì”¬ì—ì„œ GameObject.Find() í˜¸ì¶œì„ ìµœì†Œí™”
- Dictionaryë¡œ ìºì‹±í•˜ì—¬ ì¬ì‚¬ìš©
- ì”¬ ì–¸ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìºì‹œ ì •ë¦¬
```cs
private static Dictionary<string, Transform> parentCache = new();

private static Transform GetOrCreateParent(string parentName)
{
    // ìºì‹œ í™•ì¸
    if (parentCache.TryGetValue(parentName, out Transform cached))
    {
        if (cached != null) return cached;
        parentCache.Remove(parentName);  // íŒŒê´´ëœ ê²½ìš°
    }

    // Find ë˜ëŠ” ìƒì„±
    // ...
    parentCache[parentName] = parent;
    return parent;
}
```

###### ì°¸ì¡° ì¹´ìš´íŒ…
- í”„ë¦¬íŒ¹ë³„ë¡œ í˜„ì¬ ìƒì„±ëœ ì¸ìŠ¤í„´ìŠ¤ ê°œìˆ˜ ì¶”ì 
- ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ê°€ ì œê±°ë˜ë©´ ìë™ìœ¼ë¡œ í”„ë¦¬íŒ¹ í•´ì œ (Addressable Release)
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
```cs
public class ReferenceCounter<TKey, TValue>
{
    private Dictionary<TKey, int> refCounts = new();
    private Dictionary<TKey, TValue> values = new();
    private Action<TKey, TValue> onReleaseCallback;

    public void Increase(TKey key)
    {
        refCounts[key]++;
    }

    public void Decrease(TKey key)
    {
        if (--refCounts[key] <= 0)
        {
            // ì°¸ì¡° ì¹´ìš´íŠ¸ 0 â†’ í”„ë¦¬íŒ¹ í•´ì œ!
            onReleaseCallback?.Invoke(key, values[key]);
            refCounts.Remove(key);
            values.Remove(key);
        }
    }
}
```

###### ì”¬ ì „í™˜ ìë™ ì •ë¦¬
- SceneManager.sceneUnloaded ì´ë²¤íŠ¸ êµ¬ë…
- ì”¬ ì–¸ë¡œë“œ ì‹œ Parent ìºì‹œ ìë™ ì •ë¦¬
- DontDestroyOnLoad ì˜µì…˜ìœ¼ë¡œ ìœ ì§€ ê°€ëŠ¥
```cs
private static void Initialize()
{
    SceneManager.sceneUnloaded += OnSceneUnloaded;
}

private static void OnSceneUnloaded(Scene scene)
{
    parentCache.Clear();  // íŒŒê´´ëœ Parent ì°¸ì¡° ì œê±°
}
```

###### ë¹„ë™ê¸° í”„ë¦¬ë¡œë“œ
- ê²Œì„ ì‹œì‘ ì‹œ í•„ìš”í•œ ì˜¤ë¸Œì íŠ¸ ë¯¸ë¦¬ ìƒì„±
- í”„ë¦¬íŒ¹ì€ í•œ ë²ˆë§Œ ë¡œë“œí•˜ê³  ì¸ìŠ¤í„´ìŠ¤ë§Œ countê°œ ìƒì„±
- ëŸ°íƒ€ì„ ë¡œë”© ì§€ì—° ìµœì†Œí™”
```cs
await PoolManager.PreloadPool<Bullet>(10, ct);   // ì´ì•Œ 10ê°œ ë¯¸ë¦¬ ìƒì„±
await PoolManager.PreloadPool<Enemy>(5, ct);     // ì  5ê°œ ë¯¸ë¦¬ ìƒì„±
```

---
# ê²°ë¡ 
ì™¸ë¶€ì—ì„œ ì‚¬ìš©í•˜ê¸°ëŠ” ì‰½ê²Œ ë§Œë“¤ê³ , ë‚´ë¶€ì—ì„œ í•˜ëŠ” ê²Œ ë§ì€ ì‹œìŠ¤í…œ. íŠ¹íˆ Addressableê³¼ ì˜ í•©ì³ ì¨ë³´ë ¤ê³  ë…¸ë ¥í–ˆë‹¤.